<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pengajuan Usul Pensiun</title>

  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Supabase JS (versi pasti-ada, tanpa spasi) -->
  <script crossorigin
          src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/supabase-js.umd.min.js"></script>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:20px;max-width:480px;margin:auto;background:#f7f7f7}
    h2{margin-top:0}
    input,button{width:100%;padding:10px;margin:6px 0;border:1px solid #bbb;border-radius:4px;font-size:15px}
    button{background:#004c97;color:#fff;border:none;cursor:pointer}
    button:hover{opacity:.9}
    p{margin-top:8px;font-size:14px}
    form{background:#fff;padding:15px;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    /* ---------- CONFIG ---------- */
    const SUPABASE_URL  = "https://ovglutiwvikiafkpadhk.supabase.co";
    const SUPABASE_KEY  = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92Z2x1dGl3dmlraWFma3BhZGhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMjIwMDAsImV4cCI6MjA3NDg5ODAwMH0.gfP97iJcqsdknuwG03TCNM5P8my3cBksWVx3UXAw_Xo";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const e = React.createElement;

    /* ---------- APP ---------- */
    function App() {
      const [user, setUser]   = React.useState(null);
      const [msg, setMsg]     = React.useState("");
      const [email, setEmail] = React.useState("");
      const [pass, setPass]   = React.useState("");
      const [form, setForm]   = React.useState({nama:"", tgl_lahir:"", tgl_pensiun:""});

      React.useEffect(()=>{
        (async()=>{
          const {data:{session}} = await supabaseClient.auth.getSession();
          setUser(session?.user ?? null);
        })();
        const {data:listener} = supabaseClient.auth.onAuthStateChange((_event,session)=>{
          setUser(session?.user ?? null);
        });
        return ()=> listener.subscription.unsubscribe();
      },[]);

      /* ---- AUTH ---- */
      async function handleLogin(){
        const {error} = await supabaseClient.auth.signInWithPassword({email, password:pass});
        setMsg(error ? "Login gagal: "+error.message : "");
      }
      async function handleSignUp(){
        const {error} = await supabaseClient.auth.signUp({email, password:pass});
        setMsg(error ? "Error: "+error.message : "Cek email untuk verifikasi akun.");
      }
      async function handleLogout(){
        await supabaseClient.auth.signOut();
        setMsg("Berhasil logout.");
      }

      /* ---- SUBMIT ---- */
      async function handleSubmit(ev){
        ev.preventDefault();
        if(!form.nama || !form.tgl_lahir || !form.tgl_pensiun) return setMsg("Lengkapi semua data.");
        const {error} = await supabaseClient.from("pengajuan_pensiun").insert({
          user_id:user.id, ...form, created_at:new Date().toISOString()
        });
        if(error) setMsg("Gagal: "+error.message);
        else{ setMsg("Pengajuan berhasil dikirim."); setForm({nama:"",tgl_lahir:"",tgl_pensiun:""}); }
      }

      /* ---- UI ---- */
      if(!user){
        return e("div",null,
          e("h2",null,"Login / Daftar"),
          e("input",{type:"email",placeholder:"Email",value:email,onChange:ev=>setEmail(ev.target.value)}),
          e("input",{type:"password",placeholder:"Password",value:pass,onChange:ev=>setPass(ev.target.value)}),
          e("button",{onClick:handleLogin},"Login"),
          e("button",{onClick:handleSignUp},"Daftar"),
          e("p",null,msg)
        );
      }
      return e("div",null,
        e("h2",null,"Form Pengajuan Usul Pensiun"),
        e("form",{onSubmit:handleSubmit},
          e("input",{type:"text",name:"nama",placeholder:"Nama Lengkap",value:form.nama,onChange:ev=>setForm({...form,nama:ev.target.value})}),
          e("input",{type:"date",name:"tgl_lahir",value:form.tgl_lahir,onChange:ev=>setForm({...form,tgl_lahir:ev.target.value})}),
          e("input",{type:"date",name:"tgl_pensiun",value:form.tgl_pensiun,onChange:ev=>setForm({...form,tgl_pensiun:ev.target.value})}),
          e("button",{type:"submit"},"Kirim Pengajuan")
        ),
        e("button",{onClick:handleLogout,style:{marginTop:"10px"}},"Logout"),
        e("p",null,msg)
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(e(App));
  </script>
</body>
</html>
